# ThingsBoard Config Mate 功能设计文档

## 1. 设计初衷与定位

**ThingsBoard Config Mate** 旨在解决 ThingsBoard 及 ThingsBoard Edge 在私有化部署和本地开发中面临的配置繁琐痛点。

传统的配置修改往往需要深入复杂的 `thingsboard.yml` 或 `docker-compose.yml` 文件，容易出错且难以维护。本工具的设计核心是将**复杂的参数配置**简化为**可视化的交互界面**，通过标准化流程干预容器启动参数，实现“一次配置，随处运行”。

## 2. 核心设计理念

### 2.1 以 .env 为核心的配置驱动

系统采用 `.env` 环境变量文件作为配置的“单一事实来源 (Single Source of Truth)”。

- **解耦**: 将易变的配置参数（如数据库地址、密钥、功能开关）与静态的程序代码/镜像分离。
- **便携**: 运维人员只需管理轻量级的 `.env` 文件，即可控制整个系统的运行行为。

### 2.2 容器化注入机制

本工具不直接修改编译后的 JAR 包或二进制文件，而是利用 Docker 容器的特性，在**运行时 (Runtime)** 注入配置：

1. **收集**: 用户在可视化界面修改配置。
2. **生成**: 工具自动生成标准化的 `.env` 文件。
3. **注入**: 服务启动时，Docker 容器自动加载该文件，覆盖默认的 YAML 配置。

---

## 3. 功能架构

### 3.1 可视化配置管理

- **动态表单**: 自动屏蔽不仅要的底层细节，根据用户选择（如 Cloud/Edge 模式）动态展示相关配置项。
- **智能校验**: 对数据库连接、队列类型等关键参数进行实时逻辑校验，防止无效配置导致服务启动失败。
- **透明转换**:
  - 界面操作：`开启 Swagger 文档` -> `点击开关`
  - 底层转换：`SWAGGER_ENABLED=true` (写入 .env)

### 3.2 容器生命周期干预

工具深度集成了 Docker 控制能力，形成闭环的运维流程：

- **一键启动/重启**: 修改配置后，可直接触发服务重启，新配置即刻生效。
- **启动参数控制**:
  - 自动识别当前环境（Cloud 或 Edge）。
  - 自动挂载配置文件和数据卷。
  - 动态设置 JVM 参数和内存限制。

### 3.3 运维辅助

- **实时日志流**: 无需 SSH 登录服务器，直接在界面查看容器的标准输出日志，快速定位启动错误。
- **配置备份**: 每次保存配置前自动备份旧环境文件，提供“后悔药”机制。

---

## 4. 标准工作流 (Workflow)

1. **初始化 (Init)**:
   - 工具启动，读取现有的 `thingsboard.yml` 模板和环境变量。
   - 解析出当前系统的运行状态可视化展示。

2. **配置修改 (Config)**:
   - 用户在 Web 界面调整参数（例如：将数据库从 Postgres 切换为 Hybrid 模式）。
   - 工具实时校验依赖关系（例如：切换 Hybrid 模式自动要求填写 Cassandra 地址）。

3. **持久化 (Persist)**:
   - 用户点击保存。
   - 工具更新 `.env` 文件，确保配置持久化到磁盘。

4. **应用生效 (Apply)**:
   - 用户点击“重启服务”。
   - 工具调用 Docker API，使用新的环境变量重建并启动容器。
   - 系统以新的参数运行，变更生效。

### 4.1 流程图解

```mermaid
graph TD
    Start(启动工具) --> ReadConfig[读取配置]
    ReadConfig --> RenderUI[渲染 Web 界面]
    RenderUI --> UserEdit(用户修改配置)
    
    UserEdit --> Validate{校验通过?}
    Validate -- No --> UserEdit
    Validate -- Yes --> Save[.env 持久化]
    
    Save --> Restart(重启服务)
    Restart --> Inject[注入容器参数]
    Inject --> DockerUp[Docker Up]
    DockerUp --> Success((服务运行))
```

---

## 5. 总结

**ThingsBoard Config Mate** 不是一个简单的文本编辑器，而是一个**配置注入器**。它屏蔽了 Docker 和 Spring Boot 配置文件的复杂性，让运维人员和开发者能够通过直观的 GUI，安全、高效地掌控 ThingsBoard 服务的启动行为。
